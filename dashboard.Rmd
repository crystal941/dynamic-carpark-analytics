---
title: "Auckland Carpark Availability"
output:
  html_document:
    toc: true
    toc_float: true
    theme: readable
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

suppressPackageStartupMessages({
  library(readr)
  library(dplyr)
  library(tidyr)
  library(lubridate)
  library(ggplot2)
  library(scales)
  library(glue)
  library(forcats)
  library(ggh4x)
})

read_csv_safe <- function(path) {
  tryCatch(readr::read_csv(path, show_col_types = FALSE), error = function(e) NULL)
}

latest  <- read_csv_safe("data/latest.csv")
history <- read_csv_safe("data/history.csv")

# Derive last_updated text + freshness badge helpers
last_updated <- NULL
age_min_nz   <- NA_real_
last_updated_iso <- NULL

freshness_badge <- function(age_min) {
  if (is.na(age_min)) {
    return('<span style="display:inline-block;padding:2px 10px;border-radius:9999px;background:#9CA3AF;color:white;font-weight:600;">Freshness: unknown</span>')
  }
  if (age_min <= 120) {        # < 2h
    col <- "#22C55E"; label <- sprintf("Fresh â€” %.0f min ago", age_min)
  } else if (age_min <= 360) { # 2â€“6h
    col <- "#F59E0B"; label <- sprintf("Stale â€” %.0f min ago", age_min)
  } else {                     # > 6h
    col <- "#EF4444"; label <- sprintf("Out of date â€” %.0f min ago", age_min)
  }
  sprintf('<span style="display:inline-block;padding:2px 10px;border-radius:9999px;background:%s;color:white;font-weight:600;">%s</span>', col, label)
}

if (!is.null(latest) && "timestamp_utc" %in% names(latest) && nrow(latest) > 0) {
  ts_utc <- ymd_hms(latest$timestamp_utc, tz = "UTC", quiet = TRUE)
  if (any(!is.na(ts_utc))) {
    ts_nz <- with_tz(ts_utc, "Pacific/Auckland")
    last_ts_nz <- max(ts_nz, na.rm = TRUE)
    last_updated <- format(last_ts_nz, "%Y-%m-%d %H:%M:%S %Z")
    age_min_nz <- as.numeric(difftime(with_tz(Sys.time(), "Pacific/Auckland"), last_ts_nz, units = "mins"))
    last_updated_iso <- format(last_ts_nz, "%Y-%m-%dT%H:%M:%S%z")
  }
}
if (is.null(last_updated) || is.null(last_updated_iso)) {
  now_nz <- with_tz(Sys.time(), "Pacific/Auckland")
  last_updated     <- format(now_nz, "%Y-%m-%d %H:%M:%S %Z")
  last_updated_iso <- format(now_nz, "%Y-%m-%dT%H:%M:%S%z")
}

# Helper for % display
pct <- function(x) ifelse(is.na(x), NA, paste0(round(100*x, 1), "%"))

# ----- Prepare a single, reusable NZ-time history table -----
h <- NULL
if (!is.null(history) && nrow(history) > 0) {
  h <- history %>%
    mutate(
      timestamp_utc    = ymd_hms(timestamp_utc, tz = "UTC", quiet = TRUE),
      timestamp_nz     = with_tz(timestamp_utc, "Pacific/Auckland"),
      occupancy        = suppressWarnings(as.numeric(occupancy)),
      available_spaces = suppressWarnings(as.numeric(available_spaces)),
      total_spaces     = suppressWarnings(as.numeric(total_spaces))
    ) %>%
    filter(!is.na(timestamp_nz))
}
```

## Overview
**Last updated:** `r last_updated` 
```{r freshness, results='asis'}
cat(freshness_badge(age_min_nz))
```

This dashboard summarises the latest availability for selected Auckland carparks and trends over time. Data is collected hourly by an automated pipeline and rendered here.

```{r kpis, results='asis'}

if (!is.null(latest) && nrow(latest) > 0) {
  kpi <- latest %>%
    mutate(
      available_spaces = suppressWarnings(as.numeric(available_spaces)),
      total_spaces     = suppressWarnings(as.numeric(total_spaces)),
      occupancy        = suppressWarnings(as.numeric(occupancy))
    ) %>%
    summarise(
      carparks_tracked     = n_distinct(carpark),
      total_available_now  = sum(available_spaces, na.rm = TRUE),
      mean_occupancy_known = mean(occupancy[!is.na(occupancy)], na.rm = TRUE)
    )
  
  cat(glue("
  **Carparks tracked:** {kpi$carparks_tracked}  
  **Available spaces (now):** {comma(kpi$total_available_now)}  
  **Mean occupancy (where capacity known):**
  {ifelse(is.finite(kpi$mean_occupancy_known), pct(kpi$mean_occupancy_known), 'n/a')}
  "))
  } else {
  cat("No latest data available.")
}
```


## Latest snapshot

```{r}

if (!is.null(latest) && nrow(latest) > 0) {
  DT::datatable(
    latest %>%
      mutate(
        available_spaces = suppressWarnings(as.integer(available_spaces)),
        total_spaces     = suppressWarnings(as.integer(total_spaces)),
        occupancy_pct    = pct(suppressWarnings(as.numeric(occupancy)))
        ) %>%
      select(carpark, parking_option, available_spaces, total_spaces,
             occupancy_pct) %>% 
      arrange(carpark) %>%
      rename(Carpark = carpark,
             `Parking option` = parking_option,
             `Available spaces` = available_spaces,
             `Total spaces` = total_spaces,
             `Occupancy` = occupancy_pct),
    rownames = FALSE,
    options = list(pageLength = 10, dom = "tip")
    )
} else {
  cat("No latest data to display.")
}

```


## Occupancy trend

How full each carpark is over time? This view uses daily averages plus a smoothed curve to reveal longer-term patterns. ðŸ“Š

```{r}

if (!is.null(h) && nrow(h) > 0 && any(!is.na(h$occupancy))) {

  daily_occ <- h %>%
    mutate(day = as.Date(timestamp_nz)) %>%
    group_by(carpark, day) %>%
    summarise(mean_occ = mean(occupancy, na.rm = TRUE), .groups = "drop")

  ggplot(daily_occ, aes(x = day, y = mean_occ)) +
    geom_line(linewidth = 0.5, alpha = 0.7) +
    stat_smooth(method = "loess", se = FALSE, linewidth = 1.1, span = 0.2) +
    ggh4x::facet_wrap2(~ carpark, scales = "free_y", axes = "all") +
    scale_x_date(date_breaks = "1 week", date_labels = "%b %d", expand = c(0.01, 0.01)) +
    scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
    labs(title = "Occupancy (daily average with smoothed trend)",
         x = "Date (NZ time)", y = "Occupancy") +
    theme_minimal() +
    theme(legend.position = "none",
          panel.grid.minor.x = element_blank())
} else {
  cat("No occupancy values available to plot yet.")
}
```



Which days are busiest vs quietest? This weekday view reveals recurring patternsðŸš—.

```{r}

if (!is.null(h) && nrow(h) > 0 && any(!is.na(h$occupancy))) {
  dow_occ <- h %>%
    mutate(
      day = as.Date(timestamp_nz),
      # Monday-start week; ordering of labels follows week_start
      dow = lubridate::wday(day, label = TRUE, abbr = TRUE, week_start = 1)
    ) %>%
    group_by(carpark, dow) %>%
    summarise(mean_occ = mean(occupancy, na.rm = TRUE), .groups = "drop")

  ggplot(dow_occ, aes(x = dow, y = mean_occ, group = 1, colour = carpark)) +
    geom_line(linewidth = 1) +
    geom_point(size = 2) +
    ggh4x::facet_wrap2(~ carpark, axes = "all") +
    scale_y_continuous(
      limits = c(0, 1),
      labels = scales::percent_format(accuracy = 1),
      expand = c(0.01, 0.01)
    ) +
    labs(
      title = "Average occupancy by day of week",
      x = "Day of week", y = "Mean occupancy",
    ) +
    theme_minimal() +
    theme(legend.position = "none")
}

```


## Insights and Patterns

### ðŸ† Popularity ranking (overall)

```{r}
if (!is.null(h) && nrow(h) > 0) {
  h %>%
    group_by(carpark) %>%
    summarise(avg_occupancy = mean(occupancy, na.rm = TRUE)) %>%
    arrange(desc(avg_occupancy)) %>%
    ggplot(aes(x = fct_reorder(carpark, avg_occupancy), y = avg_occupancy, fill = carpark)) +
      geom_col() +
      coord_flip() +
      scale_y_continuous(labels = percent_format()) +
      labs(title = "Average occupancy by carpark (overall)", x = "Carpark", y = "Average occupancy") +
      theme_minimal() +
      theme(legend.position = "none")
}
```

### ðŸ—“ï¸ Average occupancy by day of week

```{r}
if (!is.null(h) && nrow(h) > 0) {
  h %>%
    mutate(day_of_week = wday(timestamp_nz, label = TRUE, abbr = FALSE)) %>%
    group_by(carpark, day_of_week) %>%
    summarise(mean_occupancy = mean(occupancy, na.rm = TRUE), .groups = "drop") %>%
    ggplot(aes(x = day_of_week, y = mean_occupancy, fill = carpark)) +
      geom_col(position = position_dodge(width = 0.8)) +
      scale_y_continuous(labels = percent_format()) +
      labs(title = "Average occupancy by day of week", x = "Day of week", y = "Mean occupancy") +
      theme_minimal()
}
```

### â° Hourly occupancy pattern

```{r}
if (!is.null(h) && nrow(h) > 0) {
  h %>%
    mutate(hour = hour(timestamp_nz)) %>%
    group_by(carpark, hour) %>%
    summarise(mean_occupancy = mean(occupancy, na.rm = TRUE), .groups = "drop") %>%
    ggplot(aes(x = hour, y = mean_occupancy, colour = carpark)) +
      geom_line(size = 1) +
      scale_y_continuous(labels = percent_format()) +
      labs(title = "Hourly occupancy pattern", x = "Hour of day (NZ time)", y = "Mean occupancy") +
      theme_minimal()
}
```

### ðŸ”¥ Heatmap: weekday Ã— hour

```{r}

if (!is.null(h) && nrow(h) > 0) {
  h %>%
    mutate(
      day_of_week = wday(timestamp_nz, label = TRUE, abbr = TRUE, week_start = 1),
      hour        = hour(timestamp_nz)
    ) %>%
    group_by(carpark, day_of_week, hour) %>%
    summarise(mean_occupancy = mean(occupancy, na.rm = TRUE), .groups = "drop") %>%
    mutate(
      # Ensure explicit Monâ†’Sun ordering
      day_of_week = fct_relevel(day_of_week,
        c("Mon","Tue","Wed","Thu","Fri","Sat","Sun"))
    ) %>%
    ggplot(aes(x = hour, y = day_of_week, fill = mean_occupancy)) +
      geom_tile(color = "white") +
      # Monday at TOP â†’ Sunday at BOTTOM
      scale_y_discrete(limits = rev(c("Mon","Tue","Wed","Thu","Fri","Sat","Sun"))) +
      scale_x_continuous(breaks = seq(0, 23, by = 4)) +
      scale_fill_gradient(low = "white", high = "#4ade80",
                          labels = percent_format(accuracy = 1)) +
      ggh4x::facet_wrap2(~ carpark, axes = "all") +
      labs(
        title = "Heatmap of occupancy by day and hour",
        x = "Hour of day", y = "Day of week", fill = "Mean occupancy"
      ) +
      theme_minimal()
}

```

### ðŸ“ˆ Week-over-week trend

```{r}
if (!is.null(h) && nrow(h) > 0) {
  h %>%
    mutate(week = floor_date(timestamp_nz, "week", week_start = 1)) %>%
    group_by(carpark, week) %>%
    summarise(mean_occupancy = mean(occupancy, na.rm = TRUE), .groups = "drop") %>%
    ggplot(aes(x = week, y = mean_occupancy, colour = carpark)) +
      geom_line(size = 1) +
      scale_y_continuous(labels = percent_format()) +
      labs(title = "Week-over-week occupancy trend", x = "Week", y = "Mean occupancy") +
      theme_minimal()
}
```
