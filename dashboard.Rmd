---
title: "Auckland Carpark Availability"
output:
  html_document:
    toc: true
    toc_float: true
    theme: readable
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

suppressPackageStartupMessages({
  library(readr)
  library(dplyr)
  library(tidyr)
  library(lubridate)
  library(ggplot2)
  library(scales)
  library(glue)
})

read_csv_safe <- function(path) {
  tryCatch(readr::read_csv(path, show_col_types = FALSE), error = function(e) NULL)
}

latest  <- read_csv_safe("data/latest.csv")
history <- read_csv_safe("data/history.csv")

# Derive last_updated text + freshness badge helpers
last_updated <- NULL
age_min_nz   <- NA_real_

freshness_badge <- function(age_min) {
  if (is.na(age_min)) {
    return('<span style="display:inline-block;padding:2px 10px;border-radius:9999px;background:#9CA3AF;color:white;font-weight:600;">Freshness: unknown</span>')
  }
  if (age_min <= 120) {        # < 2h
    col <- "#22C55E"; label <- sprintf("Fresh — %.0f min ago", age_min)
  } else if (age_min <= 360) { # 2–6h
    col <- "#F59E0B"; label <- sprintf("Stale — %.0f min ago", age_min)
  } else {                     # > 6h
    col <- "#EF4444"; label <- sprintf("Out of date — %.0f min ago", age_min)
  }
  sprintf('<span style="display:inline-block;padding:2px 10px;border-radius:9999px;background:%s;color:white;font-weight:600;">%s</span>', col, label)
}

if (!is.null(latest) && "timestamp_utc" %in% names(latest) && nrow(latest) > 0) {
  ts_utc <- ymd_hms(latest$timestamp_utc, tz = "UTC", quiet = TRUE)
  if (any(!is.na(ts_utc))) {
    ts_nz <- with_tz(ts_utc, "Pacific/Auckland")
    last_ts_nz <- max(ts_nz, na.rm = TRUE)
    last_updated <- format(last_ts_nz, "%Y-%m-%d %H:%M:%S %Z")
    age_min_nz <- as.numeric(difftime(with_tz(Sys.time(), "Pacific/Auckland"), last_ts_nz, units = "mins"))
  }
}
if (is.null(last_updated)) {
  now_nz <- with_tz(Sys.time(), "Pacific/Auckland")
  last_updated <- format(now_nz, "%Y-%m-%d %H:%M:%S %Z")
}


# Helper for % display
pct <- function(x) ifelse(is.na(x), NA, paste0(round(100*x, 1), "%"))

```

```{r}
# ----- Prepare a single, reusable NZ-time history table -----
h <- NULL
if (!is.null(history) && nrow(history) > 0) {
  h <- history %>%
    mutate(
      timestamp_utc    = ymd_hms(timestamp_utc, tz = "UTC", quiet = TRUE),
      timestamp_nz     = with_tz(timestamp_utc, "Pacific/Auckland"),
      occupancy        = suppressWarnings(as.numeric(occupancy)),
      available_spaces = suppressWarnings(as.numeric(available_spaces))
    ) %>%
    filter(!is.na(timestamp_nz))
}
```

## Overview
**Last updated:** `r last_updated` 
```{r freshness, results='asis'}
cat(freshness_badge(age_min_nz))
```

This dashboard summarises the latest availability for selected Auckland carparks and trends over time. Data is collected hourly by an automated pipeline and rendered here.

```{r kpis, results='asis'}

if (!is.null(latest) && nrow(latest) > 0) {
  kpi <- latest %>%
    mutate(
      available_spaces = suppressWarnings(as.numeric(available_spaces)),
      total_spaces     = suppressWarnings(as.numeric(total_spaces)),
      occupancy        = suppressWarnings(as.numeric(occupancy))
    ) %>%
    summarise(
      carparks_tracked     = n_distinct(carpark),
      total_available_now  = sum(available_spaces, na.rm = TRUE),
      mean_occupancy_known = mean(occupancy[!is.na(occupancy)], na.rm = TRUE)
    )
  
  cat(glue("
  **Carparks tracked:** {kpi$carparks_tracked}  
  **Available spaces (now):** {comma(kpi$total_available_now)}  
  **Mean occupancy (where capacity known):**
  {ifelse(is.finite(kpi$mean_occupancy_known), pct(kpi$mean_occupancy_known), 'n/a')}
  "))
  } else {
  cat("No latest data available.")
}
```


## Latest snapshot

```{r}

if (!is.null(latest) && nrow(latest) > 0) {
  latest %>%
    mutate(
      available_spaces = suppressWarnings(as.integer(available_spaces)),
      total_spaces     = suppressWarnings(as.integer(total_spaces)),
      occupancy_pct    = pct(suppressWarnings(as.numeric(occupancy)))
    ) %>%
    select(carpark, parking_option, available_spaces, total_spaces, occupancy_pct) %>%
    arrange(carpark)
} else {
  cat("No latest data to display.")
}
```


## Available spaces over time

```{r available-spaces}

if (!is.null(h) && nrow(h) > 0) {
    ggplot(h, aes(x = timestamp_nz, y = available_spaces, group = carpark,
                  colour = carpark)) +
      geom_line(na.rm = TRUE) +
      geom_point(size = 1.5, na.rm = TRUE) +
      facet_wrap(~ carpark, scales = "free_y") +
      scale_y_continuous(labels = scales::comma_format(accuracy = 1), 
                         limits = c(0, NA)) +
      labs(title = "Available spaces over time",
           x = "Timestamp (NZ time)",
           y = "Available spaces"
           ) + 
      theme(legend.position = "none")
} else {
  cat("No history available yet.")
}

```


## Occupancy trend

```{r}

if (!is.null(h) && nrow(h) > 0 && any(!is.na(h$occupancy))) {
    ggplot(h, aes(x = timestamp_nz, y = occupancy, group = carpark, 
                  colour = carpark)) +
      geom_line(na.rm = TRUE) +
      geom_point(size = 1.5, na.rm = TRUE) +
      facet_wrap(~ carpark, scales = "free_y") +
      scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                         limits = c(0, 1)) +
      labs(title = "Occupancy over time", 
           x = "Timestamp (NZ time)", 
           y = "Occupancy") +  
      theme(legend.position = "none")
} else {
    cat("No occupancy values available to plot yet.")
}
```